{% extends 'projects/base_template.html' %}
{% load staticfiles %}
{% block projectdetaillink %}#{% endblock %}
{% block title %}Project detail - {{ project.acctName }}{% endblock %}
{% block projectname %}{{ project.acctName }}{% endblock %}

{% block body %}
<h1>{{ project.acctName }}<span><a class="edit-project btn btn-xs btn-info" href="{% url 'project_edit' project.id %}">Edit Project</a></span></h1>
<p><strong>{{ project.category }}</strong></p>
<p>Project Manager: {{ project.PM }}</p>
{% if project.AM %}
<p>Account Manager: {{ project.AM }}</p>
{% endif %}
<p>{{ project.startDate }} - {{ project.endDate }}</p>
<p class="completed">
{% if project.isCompleted %}
Completed on {{ project.completedDate }}
{% else %}
<a id="mark_complete" href="#">Mark project completed</a>
{% endif %}
{% if not project.isArchived %}
<p class="archived">
<a id="archive_project" href="#">Archive project</a>
</p>
{% endif %}
<h3>Tasks</h3>
<ul>
	{% for tasklist in project.tasklist_set.all %}
		<li><a href="{% url 'tasklist_detail' project.id tasklist.id %}">{{ tasklist.name }}</a> <a class="tasklist_edit btn btn-xs btn-info" href="{% url 'tasklist_edit' project.id tasklist.id %}">Edit</a></li>
		{% if tasklist.task_set.all %}
		<ul>
		{% for task in tasklist.task_set.all %}
			{% if not task.isCompleted %}
			<li><a href="{% url 'task_detail' tasklist.id task.id %}">{{ task.name }}</a> <a class="task_edit btn btn-xs btn-info" href="{% url 'task_edit' tasklist.id task.id %}">Edit</a> <a class="task_complete btn btn-xs btn-warning" id="task_{{ task.id }}" aria-tasklistid="{{ tasklist.id }}" aria-taskid="{{ task.id }}">Done</a></li>
		  	{% endif %}
		{% endfor %}
		</ul>
		{% endif %}
	{% endfor %}
</ul>

<div><a class="btn btn-primary" href="{% url 'tasklist_add' project.id %}">Add tasklist</a>
<a class="btn btn-success" href="{% url 'tasklist_add_from_template' project.id %}">Add tasklist from template</a></div>
<h3>Risks</h3>
<ul>
	{% for risk in project.risk_set.all %}
		<li>{{ risk.name }}</li>
	{% endfor %}
</ul>
<h3>Links</h3>
<ul>
	{% for link in project.link_set.all %} 
		<li><a target="blank" href="{{ link.code }}">{{ link.name }}</a> <a class="link-edit btn btn-xs btn-info" href="{% url 'link_edit' project.id link.id %}">Edit</a> <a class="link-detail btn btn-xs btn-warning" href="{% url 'link_detail' project.id link.id %}">Detail</a></li>
	{% endfor %}
</ul>
<p><a class="btn btn-primary" href="{% url 'link_add' project.id %}">Add link</a></p> 
{% csrf_token %}
{% endblock %}

{% block body_js %}
<script src="{% static 'projects/js/jquery.cookie.js' %}"></script>
<script type="text/javascript">
	function csrfSafeMethod(method) {
	    // these HTTP methods do not require CSRF protection
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

	$.ajaxSetup({
	    beforeSend: function(xhr, settings) {
			var csrftoken = $.cookie('csrftoken');
	        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
	            xhr.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	    }
	});

	$('#archive_project').click(function() {
		$.ajax({
			type: "POST",
			url: "/projects/{{ project.id }}/archive/",
			success: function(result, textStatus, xmlhttprequest) {
				code = $.parseJSON(xmlhttprequest.responseText).HTTPRESPONSE;
				if (code == 1) {
					$('.archived').html('Project archived.');
				}
			}
		});
	});

	$('#mark_complete').click(function() {
		$.ajax({
			type: "POST",
			url: "/projects/{{ project.id }}/complete/",
			success: function(result, textStatus, xmlhttprequest) {
				code = $.parseJSON(xmlhttprequest.responseText).HTTPRESPONSE;
				if (code == 1) {
					$('.completed').html('Project complete!');
				}
			}
		});
	});

	$('.task_complete').click(function() {
		var tasklistid = $(this).attr('aria-tasklistid');
		var taskid = $(this).attr('aria-taskid');
		$.ajax({
			type: "POST",
			url: "/projects/tasklist/" + tasklistid + "/task/" + taskid + "/complete/",
			success: function(result, textStatus, xmlhttprequest) {
				code = $.parseJSON(xmlhttprequest.responseText).HTTPRESPONSE;
				if (code == 1) {
					$('#task_' + taskid).hide(); // hide Done button
					$(this).parent().addClass('strike'); // strike out text
				}
			}
		});
	});
</script>
{% endblock %}